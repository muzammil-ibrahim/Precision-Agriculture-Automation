{"version":3,"file":"utils.js","sources":["../src/utils.ts"],"sourcesContent":["import * as React from 'react';\r\nimport { debounce, throttle } from 'es-toolkit/compat'\r\nimport type { DebouncedFunc } from 'es-toolkit/compat'\r\n\r\n\r\nimport { OnRefChangeType, Props } from './types.js';\r\n\r\nexport type PatchedResizeObserverCallback = DebouncedFunc<ResizeObserverCallback> | ResizeObserverCallback;\r\n\r\n/**\r\n * Wraps the resize callback with a es-toolkit debounce / throttle based on the refresh mode\r\n */\r\nexport const patchResizeCallback = (\r\n  resizeCallback: ResizeObserverCallback,\r\n  refreshMode: Props['refreshMode'],\r\n  refreshRate: Props['refreshRate'],\r\n  refreshOptions: Props['refreshOptions'],\r\n): PatchedResizeObserverCallback => {\r\n  switch (refreshMode) {\r\n    case 'debounce':\r\n      return debounce(resizeCallback, refreshRate, refreshOptions);\r\n    case 'throttle':\r\n      return throttle(resizeCallback, refreshRate, refreshOptions);\r\n    default:\r\n      return resizeCallback;\r\n  }\r\n};\r\n\r\n/**\r\n * A custom hook that converts a callback to a ref to avoid triggering re-renders when passed as a\r\n * prop or avoid re-executing effects when passed as a dependency\r\n */\r\nexport const useCallbackRef =\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  <T extends (...args: any[]) => any>(callback: T | undefined): T => {\r\n    const callbackRef = React.useRef(callback);\r\n\r\n    React.useEffect(() => {\r\n      callbackRef.current = callback;\r\n    });\r\n\r\n    return React.useMemo(() => ((...args) => callbackRef.current?.(...args)) as T, []);\r\n  };\r\n\r\n/** `useRef` hook doesn't handle conditional rendering or dynamic ref changes.\r\n * This hook creates a proxy that ensures that `refElement` is updated whenever the ref is changed. */\r\nexport const useRefProxy =\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  <T extends HTMLElement = any>(targetRef: React.MutableRefObject<T | null> | undefined) => {\r\n    // we are going to use this ref to store the last element that was passed to the hook\r\n    const [refElement, setRefElement] = React.useState<T | null>(targetRef?.current || null);\r\n\r\n    // if targetRef is passed, we need to update the refElement\r\n    // we have to use setTimeout because ref get assigned after the hook is called\r\n    // in the future releases we are going to remove targetRef and force users to use ref returned by the hook\r\n    if (targetRef) {\r\n      setTimeout(() => {\r\n        if (targetRef.current !== refElement) {\r\n          setRefElement(targetRef.current);\r\n        }\r\n      }, 0);\r\n    }\r\n\r\n    // this is a memo that will be called every time the ref is changed\r\n    // This proxy will properly call setState either when the ref is called as a function or when `.current` is set\r\n    // we call setState inside to trigger rerender\r\n    const refProxy: OnRefChangeType<T> = React.useMemo(\r\n      () =>\r\n        new Proxy(\r\n          (node) => {\r\n            if (node !== refElement) {\r\n              setRefElement(node);\r\n            }\r\n          },\r\n          {\r\n            get(target, prop) {\r\n              if (prop === 'current') {\r\n                return refElement;\r\n              }\r\n              return target[prop];\r\n            },\r\n            set(target, prop, value) {\r\n              if (prop === 'current') {\r\n                setRefElement(value);\r\n              } else {\r\n                target[prop] = value;\r\n              }\r\n              return true;\r\n            },\r\n          },\r\n        ),\r\n      [refElement],\r\n    );\r\n\r\n    return { refProxy, refElement, setRefElement };\r\n  };\r\n\r\n/** Calculates the dimensions of the element based on the current box model.\r\n * @see https://developer.mozilla.org/en-US/docs/Learn/CSS/Building_blocks/The_box_model\r\n */\r\nexport const getDimensions = (entry: ResizeObserverEntry, box: ResizeObserverBoxOptions | undefined) => {\r\n  // Value\t          Border\t  Padding\t  Inner Content\r\n  // ---------------------------------------------------\r\n  // 'border-box'\t    Yes\t      Yes\t      Yes\r\n  // 'content-box'\t  No\t      No\t      Yes\r\n  //  undefined       No\t      No?\t      Yes\r\n\r\n  const borderBox = entry.borderBoxSize?.[0];\r\n  const contentBox = entry.contentBoxSize?.[0];\r\n\r\n  if (box === 'border-box' && borderBox) {\r\n    return {\r\n      width: borderBox.inlineSize,\r\n      height: borderBox.blockSize,\r\n    };\r\n  }\r\n\r\n  if (box === 'content-box' && contentBox) {\r\n    return {\r\n      width: contentBox.inlineSize,\r\n      height: contentBox.blockSize,\r\n    };\r\n  }\r\n\r\n  return {\r\n    width: entry.contentRect.width,\r\n    height: entry.contentRect.height,\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}